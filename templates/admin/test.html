{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Add Product</title>
    <link rel="stylesheet" href="{% static 'admin/vendors/mdi/css/materialdesignicons.min.css' %}">
    <link rel="stylesheet" href="{% static 'admin/vendors/css/vendor.bundle.base.css' %}">
    <link rel="stylesheet" href="{% static 'admin/css/style.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link rel="shortcut icon" href="{% static 'admin/images/favicon.png' %}">
    <style>
        .preview-image {
            width: 200px;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 10px;
        }
        .image-preview-container {
            display: inline-block;
            margin: 10px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            background: #fff;
            text-align: center;
            position: relative;
        }
        .image-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }
        .btn-action {
            padding: 8px 16px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        .btn-crop {
            background: #4B49AC;
        }
        .btn-crop:hover {
            background: #3c3a8c;
        }
        .btn-delete {
            background: #dc3545;
        }
        .btn-delete:hover {
            background: #c82333;
        }
        .btn-add {
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .btn-add:hover {
            background: #218838;
        }
        #imagePreviews {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 20px;
        }
        .cropper-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .cropper-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            height: 90vh;
            max-height: 600px;
            display: flex;
            flex-direction: column;
        }
        .cropper-content {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        .cropper-content img {
            max-width: 100%;
            max-height: calc(100vh - 200px);
        }
        .cropper-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .hidden {
            display: none !important;
        }
        .preview-container {
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container-scroller">
        {% include 'admin/sidebar.html' %}
        <div class="container-fluid page-body-wrapper">
            {% include 'admin/navbar.html' %}
            <div class="main-panel">
                <div class="content-wrapper">
                    {% if messages %}
                    <div class="alert-container">
                        {% for message in messages %}
                        <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-12 grid-margin">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="card-title">Add New Product</h4>
                                    <form id="createProductForm" method="POST" enctype="multipart/form-data" action="{% url 'create_product' %}" onsubmit="return validateForm()">
                                        {% csrf_token %}
                                        <div class="form-group">
                                            <label for="name">Product Name</label>
                                            <input type="text" class="form-control" id="name" name="product_name" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="description">Description</label>
                                            <textarea class="form-control" id="description" name="description" rows="4" required></textarea>
                                        </div>
                                        <div class="form-group">
                                            <label for="category">Category</label>
                                            <select class="form-control" id="category" name="category" required>
                                                <option value="" disabled selected>Select Category</option>
                                                {% for category in categories %}
                                                <option value="{{ category.id }}">{{ category.category_name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="form-group">
                                            <label for="price">Price</label>
                                            <input type="number" class="form-control" id="price" name="price" step="0.01" min="0" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="color">Color</label>
                                            <input type="text" class="form-control" id="color" name="color" required>
                                        </div>
                                        <div class="form-group">
                                            <label for="offer">Offer</label>
                                            <input type="number" class="form-control" id="offer" name="offer" step="0.01" min="0">
                                        </div>
    
                                        <div class="form-group">
                                            <label>Product Images</label>
                                            <div class="image-upload-container">
                                                <input type="file" class="hidden" id="imageInput" accept="image/*">
                                                <button type="button" class="btn btn-action btn-add" id="addImageBtn">
                                                    Add Image
                                                </button>
                                            </div>
                                            <div id="imagePreviews"></div>
                                        </div>
    
                                        <div class="mt-4">
                                            <button type="submit" class="btn btn-primary me-2">Create Product</button>
                                            <a href="{% url 'product_management' %}" class="btn btn-secondary">Cancel</a>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cropper Modal -->
    <div id="cropperModal" class="cropper-modal">
        <div class="cropper-container">
            <div class="cropper-content">
                <img id="cropperImage" src="" alt="Image to crop">
            </div>
            <div class="cropper-actions">
                <button class="btn btn-primary" id="saveCrop">Save Crop</button>
                <button class="btn btn-secondary" id="cancelCrop">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Required Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const imageInput = document.getElementById('imageInput');
            const addImageBtn = document.getElementById('addImageBtn');
            const imagePreviews = document.getElementById('imagePreviews');
            const cropperModal = document.getElementById('cropperModal');
            const cropperImage = document.getElementById('cropperImage');
            let cropper = null;
            let currentImageContainer = null;

            // Handle Add Image button click
            addImageBtn.addEventListener('click', function() {
                imageInput.click();
            });

            // Handle image selection
            imageInput.addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (!file) return;

                if (!file.type.startsWith('image/')) {
                    Swal.fire({
                        title: 'Invalid File',
                        text: 'Please select an image file',
                        icon: 'error'
                    });
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    addImagePreview(e.target.result, file.name);
                };
                reader.readAsDataURL(file);
                imageInput.value = ''; // Reset input for next selection
            });

            function addImagePreview(src, fileName) {
                const previewContainer = document.createElement('div');
                previewContainer.classList.add('image-preview-container');
                
                const img = document.createElement('img');
                img.src = src;
                img.classList.add('preview-image');
                previewContainer.appendChild(img);

                const actionsDiv = document.createElement('div');
                actionsDiv.classList.add('image-actions');

                const cropBtn = document.createElement('button');
                cropBtn.textContent = 'Crop';
                cropBtn.classList.add('btn-action', 'btn-crop');
                cropBtn.type = 'button';
                actionsDiv.appendChild(cropBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete';
                deleteBtn.classList.add('btn-action', 'btn-delete');
                deleteBtn.type = 'button';
                actionsDiv.appendChild(deleteBtn);

                previewContainer.appendChild(actionsDiv);
                imagePreviews.appendChild(previewContainer);

                // Create hidden input for the image
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'product_images[]';
                hiddenInput.value = src;
                previewContainer.appendChild(hiddenInput);

                // Event listeners
                cropBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openCropper(img.src, previewContainer);
                });

                deleteBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    previewContainer.remove();
                });
            }

            function openCropper(imageUrl, container) {
                cropperModal.style.display = 'flex';
                cropperImage.src = imageUrl;
                currentImageContainer = container;

                // Destroy existing cropper if it exists
                if (cropper) {
                    cropper.destroy();
                }

                // Initialize cropper with a slight delay to ensure image is loaded
                setTimeout(() => {
                    cropper = new Cropper(cropperImage, {
                        aspectRatio: 1,
                        viewMode: 2,
                        dragMode: 'move',
                        autoCropArea: 1,
                        zoomable: true,
                        scalable: true,
                        guides: true,
                        highlight: true,
                        cropBoxMovable: true,
                        cropBoxResizable: true,
                        responsive: true
                    });
                }, 100);
            }

            document.getElementById('saveCrop').addEventListener('click', function(e) {
                e.preventDefault();
                if (cropper && currentImageContainer) {
                    const croppedCanvas = cropper.getCroppedCanvas({
                        width: 800,
                        height: 800,
                        imageSmoothingEnabled: true,
                        imageSmoothingQuality: 'high'
                    });

                    const croppedImageUrl = croppedCanvas.toDataURL('image/jpeg', 0.9);
                    const img = currentImageContainer.querySelector('img');
                    const hiddenInput = currentImageContainer.querySelector('input[type="hidden"]');
                    
                    img.src = croppedImageUrl;
                    hiddenInput.value = croppedImageUrl;
                    
                    closeCropper();
                }
            });

            document.getElementById('cancelCrop').addEventListener('click', function(e) {
                e.preventDefault();
                closeCropper();
            });

            function closeCropper() {
                cropperModal.style.display = 'none';
                if (cropper) {
                    cropper.destroy();
                    cropper = null;
                }
                currentImageContainer = null;
            }

            // Form validation
            window.validateForm = function() {
                const images = document.querySelectorAll('input[name="product_images[]"]');
                if (images.length === 0) {
                    Swal.fire({
                        title: 'Images Required',
                        text: 'Please add at least one image for the product',
                        icon: 'warning'
                    });
                    return false;
                }
                return true;
            };

            // Close cropper modal when clicking outside
            cropperModal.addEventListener('click', function(e) {
                if (e.target === cropperModal) {
                    closeCropper();
                }
            });
        });
    </script>
</body>
</html>