<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .addresses, .cart-items, .totals {
            margin-bottom: 20px;
        }
        .address, .cart-item {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        .totals {
            font-size: 1.2em;
        }
        .error {
            color: red;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Checkout</h1>

    <!-- Display Default Address -->
    <div class="addresses">
        <h2>Delivery Address</h2>
        <div class="address">
            <div id="default-address">
                {% if default_address %}
                    <p><strong>Name:</strong> {{ default_address.name }}</p>
                    <p><strong>Address:</strong> {{ default_address.address }}</p>
                    <p><strong>City:</strong> {{ default_address.city }}</p>
                    <p><strong>State:</strong> {{ default_address.state }}</p>
                    <p><strong>Country:</strong> {{ default_address.country }}</p>
                    <p><strong>Postcode:</strong> {{ default_address.postcode }}</p>
                    <p><strong>Phone:</strong> {{ default_address.phone }}</p>
                    <p><strong>Email:</strong> {{ default_address.email }}</p>
                    <p><strong>Additional Info:</strong> {{ default_address.additional_info }}</p>
                {% else %}
                    <p>No default address found. Please add an address.</p>
                {% endif %}
            </div>
            <button onclick="showChangeAddress()">Change Address</button>
        </div>
    </div>

    <!-- Change Address Section (Hidden by Default) -->
    <div id="change-address-section" class="hidden">
        <h3>Select or Add Address</h3>
        {% for address in addresses %}
            <div class="address">
                <p><strong>Name:</strong> {{ address.name }}</p>
                <p><strong>Address:</strong> {{ address.address }}</p>
                <p><strong>City:</strong> {{ address.city }}</p>
                <p><strong>State:</strong> {{ address.state }}</p>
                <p><strong>Country:</strong> {{ address.country }}</p>
                <p><strong>Postcode:</strong> {{ address.postcode }}</p>
                <p><strong>Phone:</strong> {{ address.phone }}</p>
                <p><strong>Email:</strong> {{ address.email }}</p>
                <p><strong>Additional Info:</strong> {{ address.additional_info }}</p>
                <button data-address-id="{{ address.id }}" onclick="selectAddress(this)">Select</button>
            </div>
        {% endfor %}
        <button onclick="showAddAddressModal()">Add New Address</button>
    </div>

    <!-- Display Cart Items -->
    <div class="cart-items">
        <h2>Your Cart</h2>
        {% for item in cart_items %}
            <div class="cart-item">
                {% if item.product_variant.product.offer %}
                <p>{{ item.product_variant.product.name }} MRP - ₹{{ item.product_variant.product.price }} Offer Price - ₹{{ item.product_variant.product.offer }}</p>
                <p>{{ item.quantity }} x ₹{{ item.product_variant.product.offer }}</p>
                <p>Subtotal: ₹{{ item.subtotal }}</p>
                {% else %}
                <p>{{ item.product_variant.product.name }} MRP - ₹{{ item.product_variant.product.price }}</p>
                <p>{{ item.quantity }} x ₹{{ item.product_variant.product.price }}</p>
                <p>Subtotal: ₹{{ item.subtotal }}</p>
                {% endif %}
            </div>
        {% endfor %}
    </div>

    <!-- Display Totals -->
    <div class="totals">
        <p>Delivery Charge: ₹{{ delivery_charge }}</p>
        <p><strong>Total: ₹{{ total }}</strong></p>
    </div>

    <!-- Payment Method Selection -->
    <div class="payment__methods">
        <h3 class="checkout__title payment__title">Payment</h3>
        <div class="payment__option flex">
            <input type="radio" name="payment_method" value="COD" id="cod" class="payment__input"/>
            <label for="cod" class="payment__label">Cash on Delivery</label>
        </div>
        <div class="payment__option flex">
            <input type="radio" name="payment_method" id="razorpay" value="razorpay" class="payment__input"/>
            <label for="onlinepay" class="payment__label">Online Payment</label>
        </div>
    </div>
    
    <!-- Place Order Form -->
    <form method="POST" action="{% url 'place_order' %}" id="place-order-form">
        {% csrf_token %}
        <input type="hidden" name="address_id" id="address-id" value="{{ default_address.id|default:'' }}">
        <input type="hidden" name="payment_method" id="payment-method-hidden">
        <button id="placeOrderBtn" class="btn btn--md" type="button" onclick="placeOrder()">Place Order</button>
    </form>

    <!-- Error Message Display -->
    <div id="error-message" class="error"></div>

    <!-- Add Address Modal -->
    <div id="add-address-modal" class="hidden">
        <h3>Add New Address</h3>
        <form id="add-address-form" method="post" action="{% url 'add_address' %}">
            {% csrf_token %}
            <div class="mb-3">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name" required>
            </div>
            <div class="mb-3">
                <label for="address">Address:</label>
                <input type="text" id="address" name="address" required>
            </div>
            <div class="mb-3">
                <label for="city">City:</label>
                <input type="text" id="city" name="city" required>
            </div>
            <div class="mb-3">
                <label for="state">State:</label>
                <input type="text" id="state" name="state" required>
            </div>
            <div class="mb-3">
                <label for="country">Country:</label>
                <input type="text" id="country" name="country" required>
            </div>
            <div class="mb-3">
                <label for="postcode">Postcode:</label>
                <input type="text" id="postcode" name="postcode" required>
            </div>
            <div class="mb-3">
                <label for="phone">Phone:</label>
                <input type="text" id="phone" name="phone" required>
            </div>
            <div class="mb-3">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email">
            </div>
            <div class="mb-3">
                <label for="additional_info">Additional Info:</label>
                <textarea id="additional_info" name="additional_info" rows="3"></textarea>
            </div>
            <button type="submit">Save Address</button>
        </form>
    </div>

    <script>
        let selectedAddressId = "{{ default_address.id|default:'' }}"; // Pre-select default address
    
        // Function to show the "Change Address" section
        function showChangeAddress() {
            document.getElementById('change-address-section').classList.remove('hidden');
        }
    
        // Function to select an address
        function selectAddress(button) {
            selectedAddressId = button.getAttribute("data-address-id");
    
            // Get the selected address details from the button's parent element
            const addressDetails = button.parentElement.querySelectorAll('p');
    
            // Update the default address section with the selected address details
            const defaultAddressDiv = document.getElementById('default-address');
            defaultAddressDiv.innerHTML = ''; // Clear the current content
    
            addressDetails.forEach(detail => {
                defaultAddressDiv.innerHTML += `<p>${detail.innerHTML}</p>`;
            });
    
            alert("Address selected: " + selectedAddressId);
            document.getElementById('change-address-section').classList.add('hidden');
        }
    
        // Function to show the "Add Address" modal
        function showAddAddressModal() {
            document.getElementById('add-address-modal').classList.remove('hidden');
        }
    
        // Function to handle adding a new address
        document.getElementById('add-address-form').addEventListener('submit', async function (event) {
            event.preventDefault();
            const formData = new FormData(event.target);
            const response = await fetch("{% url 'add_address' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: formData
            });
    
            if (response.ok) {
                alert("Address added successfully!");
                window.location.reload(); // Reload the page to reflect the new address
            } else {
                alert("Failed to add address.");
            }
        });
    
        // Function to place order
        async function placeOrder() {
            const paymentMethod = document.getElementById("payment-method").value;
    
            if (!selectedAddressId) {
                document.getElementById("error-message").innerText = "Please select an address.";
                return;
            }
    
            const response = await fetch("/place_order/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                body: JSON.stringify({
                    address_id: selectedAddressId,
                    payment_method: paymentMethod
                })
            });
    
            const data = await response.json();
    
            if (response.ok) {
                window.location.href = "/order_success/";
            } else {
                document.getElementById("error-message").innerText = data.error;
            }
        }
    </script>
    
</body>
</html>