{% extends 'base.html' %}
{% block title %}{{ product.name }} - Product Details{% endblock %}
{% load static %}

{% block content %}
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Roboto', sans-serif;
        background-color: #f4f4f4;
    }

    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        padding-top: 100px;
        /* Account for navbar height */
    }

    /* Product Details Section */
    .product-details {
        display: flex;
        gap: 50px;
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        padding: 30px;
    }

    .product-images {
        flex: 1;
        position: relative;
        text-align: center;
        overflow: hidden;
        /* Ensures zoomed image doesn't overflow the container */
    }

    .main-image {
        width: 100%;
        max-width: 500px;
        border-radius: 10px;
        cursor: zoom-in;
        /* Add cursor style for hover */
        transition: transform 0.3s ease;
    }

    .thumbnail-images {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }

    .thumbnail-images img {
        width: 70px;
        height: 70px;
        border-radius: 8px;
        cursor: pointer;
        transition: transform 0.2s ease;
    }

    .thumbnail-images img:hover {
        transform: scale(1.1);
    }

    .product-info {
        flex: 1.5;
    }

    .product-info h1 {
        font-size: 2.2rem;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
    }

    .price {
        font-size: 1.8rem;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .price .original {
        text-decoration: line-through;
        color: #999;
        font-size: 1.5rem;
        margin-right: 10px;
    }

    .price .offer {
        color: #e63946;
        /* Attractive color for the offer price */
    }

    .product-info .description {
        font-size: 1rem;
        color: #555;
        line-height: 1.6;
        margin-bottom: 30px;
    }

    .dropdown {
        margin-bottom: 20px;
    }

    .dropdown select {
        width: 100%;
        padding: 12px;
        font-size: 1rem;
        border-radius: 5px;
        border: 1px solid #ddd;
        background-color: #f9f9f9;
        transition: border-color 0.3s ease;
    }

    .dropdown select:hover {
        border-color: #007bff;
    }

    /* Add to Cart and Wishlist Buttons */
    .wishlist-cart {
        display: flex;
        gap: 15px;
        margin-top: 20px;
    }

    .wishlist-cart button {
        padding: 12px 20px;
        border-radius: 5px;
        font-size: 1.1rem;
        border: none;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .wishlist-cart .add-to-cart {
        background-color: #007bff;
        color: white;
    }

    .wishlist-cart .add-to-cart:hover {
        background-color: #0056b3;
    }

    .wishlist-cart .add-to-wishlist {
        background-color: #f39c12;
        color: white;
    }

    .wishlist-cart .add-to-wishlist:hover {
        background-color: #e67e22;
    }

    /* Popup Notification */
    .popup {
        min-width: 300px;
        min-height: 80px;
        position: absolute;
        top: 10px;
        right: 0;
        background-color: rgb(255, 255, 255);
        font-family: sans-serif;
        font-size: 13px;
        font-weight: 900;
        color: hsl(176, 71%, 54%);
        border-radius: 4px;
        display: none;
        flex-direction: column;
        padding-top: 5px;
        justify-content: center;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.4);
    }

    .popup h3 {
        margin: 10px 10px;
    }

    .popup hr {
        width: 100%;
        height: 4px;
        background-color: hsla(176, 51%, 49%, 0.562);
        border-radius: 10px;
        border: none;
    }

    #countdown {
        position: absolute;
        bottom: 0;
    }

    .active {
        animation: sajjad 5s ease infinite;
    }

    /* Related Products Section */

    .container-fluid {
        max-width: 1650px;
        margin: 0 auto;
        padding: 20px;
        /* padding-top: 10px; */
        /* Account for navbar height */
    }

    .related-products {
        width: 100%;
        padding: 30px 100px;
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
        margin-top: 10px;
    }

    .related-products h2 {
        font-size: 2.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
    }

    .product-list {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        /* Create a 4-column grid */
        gap: 30px;
        padding: 0 15px;
    }

    .product {
        background-color: #fff;
        border: 1px solid #ddd;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        /* Ensures that content doesn't spill outside the card */
    }

    .product img {
        width: 100%;
        border-radius: 8px;
        margin-bottom: 15px;
        transition: transform 0.3s ease;
    }

    .product img:hover {
        transform: scale(1.05);
    }

    .product-name {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        height: 3em;
        /* Limit height to two lines */
        line-height: 1.5em;
        /* Control line height */
        overflow: hidden;
        text-overflow: ellipsis;
        display: block;
        margin-bottom: 10px;
    }

    .price {
        font-size: 1.2rem;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .original {
        text-decoration: line-through;
        color: #999;
        font-size: 1rem;
        margin-right: 10px;
    }

    .offer {
        color: #e63946;
        /* Red color for the offer price */
    }

    .wishlist-cart {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
    }

    .wishlist-cart .add-to-cart {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        font-size: 1rem;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .wishlist-cart .add-to-cart:hover {
        background-color: #0056b3;
    }

    .wishlist-cart .btn-primary {
        padding: 10px 20px;
        background-color: #f39c12;
        color: white;
        font-size: 1rem;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
    }

    .wishlist-cart .btn-primary:hover {
        background-color: #e67e22;
    }

    @media (max-width: 1024px) {
        .product-list {
            grid-template-columns: repeat(3, 1fr);
            /* 3 columns for medium screens */
        }
    }


    @media (max-width: 768px) {
        .product {
            width: calc(50% - 30px);
            /* Make each product take up 50% of the width on smaller screens */
        }

        .product-list {
            grid-template-columns: repeat(2, 1fr);
            /* 2 columns for smaller screens */
        }
    }


    @media (max-width: 480px) {
        .product {
            width: 100%;
            /* Make each product take up the full width on very small screens */
        }

        .product-list {
            grid-template-columns: 1fr;
            /* 1 column for very small screens */
        }
    }



    @keyframes sajjad {
        0% {
            width: 100%;
        }

        100% {
            width: 0;
        }
    }
</style>

<div class="container">
    <div class="product-details">
        <!-- Product Images -->
        <section class="product-images" id="image-container">
            {% if product_images %}
            <img src="{{ product_images.0.image.url }}" alt="{{ product.name }}" class="main-image" id="zoom-image">
            <div class="thumbnail-images">
                {% for image in product_images %}
                <img src="{{ image.image.url }}" alt="{{ product.name }}"
                    onclick="changeImage('{{ image.image.url }}')">
                {% endfor %}
            </div>
            {% else %}
            <p>No images available for this product.</p>
            {% endif %}
        </section>

        <!-- Product Info -->
        <div class="product-info">
            <h1>{{ product.name }}</h1>
            <p class="price">
                {% if product.offer %}
                <span class="original">₹{{ product.price }}</span>
                <span class="offer">₹{{ product.offer }}</span>
                {% else %}
                ₹{{ product.price }}
                {% endif %}
            </p>
            <p class="description">{{ product.description }}</p>

            <!-- Variant Selection -->
            <div class="dropdown">
                <label for="color">Select Color:</label>
                <select id="color" onchange="updateSizes()">
                    {% for color in unique_colors %}
                    <option value="{{ color }}" {% if loop.first %}selected{% endif %}>{{ color }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="dropdown">
                <label for="size">Select Size:</label>
                <select id="size">
                    <option value="">Select a color first</option>
                </select>
            </div>

            <!-- Add to Cart and Wishlist -->
            <!-- <div class="wishlist-cart">
                <button class="add-to-cart" onclick="addToCart('{{ product.id }}')">Add to Cart</button>
                <button class="add-to-wishlist">Add to Wishlist</button>
            </div> -->
            <!-- Add this div above the "Add to Cart" button -->
            <div id="cart-message" style="display: none; margin-bottom: 10px; padding: 10px; border-radius: 5px;"></div>

            <!-- Add to Cart and Wishlist -->
            <div class="wishlist-cart">
                <button class="add-to-cart" onclick="addToCart('{{ product.id }}')">Add to Cart</button>
                <button class="add-to-wishlist">Add to Wishlist</button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <!-- Related Products Section -->
    {% if related_products %}
    <section class="related-products">
        <div class="text-center">
            <h2 class="section-title">Related Products</h2>
        </div>
        <div class="product-list">
            {% for related_product in related_products %}
            <div class="product">
                <img src="{{ related_product.images.first.image.url }}" alt="{{ related_product.name }}">
                <p class="product-name">{{ related_product.name }}</p>
                <p class="price">
                    {% if related_product.offer %}
                    <span class="original">₹{{ related_product.price }}</span>
                    <span class="offer">₹{{ related_product.offer }}</span>
                    {% else %}
                    ₹{{ related_product.price }}
                    {% endif %}
                </p>
                <div class="wishlist-cart">
                    <button class="add-to-cart" onclick="addToCart('{{ related_product.id }}')">Add to Cart</button>
                    <a href="{% url 'product_details' related_product.id %}" class="btn-primary">View Details</a>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>



<!-- Popup Notification -->
<div class="popup" id="popup">
    <div class="description">
        <div class="check" id="check">
            <svg xmlns="http://www.w3.org/2000/svg" height="34px" viewBox="0 -960 960 960" width="24px" fill="#fff">
                <path d="M382-240 154-468l57-57 171 171 367-367 57 57-424 424Z" />
            </svg>
        </div>
        <h3 id="text"></h3>
    </div>
    <hr id="countdown">
</div>

{% block extra_js %}
<script>
    // Image zoom handling
    const imageContainer = document.getElementById("image-container");
    const mainImage = document.getElementById("zoom-image");
    let isZoomed = false;

    if (imageContainer) {
        imageContainer.addEventListener('mousemove', function (e) {
            if (!isZoomed) return;

            const { left, top, width, height } = this.getBoundingClientRect();
            const x = (e.clientX - left) / width;
            const y = (e.clientY - top) / height;

            mainImage.style.transformOrigin = `${x * 100}% ${y * 100}%`;
        });

        imageContainer.addEventListener('mouseenter', function () {
            isZoomed = true;
            mainImage.style.transform = 'scale(1.5)';
        });

        imageContainer.addEventListener('mouseleave', function () {
            isZoomed = false;
            mainImage.style.transform = 'scale(1)';
            mainImage.style.transformOrigin = 'center center';
        });

        // Add touch support for mobile devices
        let touchTimeout;
        imageContainer.addEventListener('touchstart', function () {
            touchTimeout = setTimeout(() => {
                isZoomed = !isZoomed;
                mainImage.style.transform = isZoomed ? 'scale(1.5)' : 'scale(1)';
            }, 200);
        });

        imageContainer.addEventListener('touchend', function () {
            clearTimeout(touchTimeout);
        });

        imageContainer.addEventListener('touchmove', function (e) {
            if (!isZoomed) return;

            const touch = e.touches[0];
            const { left, top, width, height } = this.getBoundingClientRect();
            const x = (touch.clientX - left) / width;
            const y = (touch.clientY - top) / height;

            mainImage.style.transformOrigin = `${x * 100}% ${y * 100}%`;
            e.preventDefault(); // Prevent page scrolling while zoomed
        });
    }

    const colorSizeDict = JSON.parse('{{ color_size_dict|escapejs }}');

    function updateSizes() {
        const selectedColor = document.getElementById("color").value;
        const sizeDropdown = document.getElementById("size");

        sizeDropdown.innerHTML = "";
        if (!selectedColor) {
            const defaultOption = document.createElement("option");
            defaultOption.value = "";
            defaultOption.text = "Select a color first";
            sizeDropdown.appendChild(defaultOption);
            return;
        }

        const availableSizes = colorSizeDict[selectedColor] || [];

        if (availableSizes.length > 0) {
            availableSizes.forEach(function (size, index) {
                const option = document.createElement("option");
                option.value = size;
                option.text = size;

                if (index === 0) {
                    option.selected = true;
                }

                sizeDropdown.appendChild(option);
            });
        } else {
            const option = document.createElement("option");
            option.value = "";
            option.text = "No sizes available for this color";
            option.disabled = true;
            sizeDropdown.appendChild(option);
        }
    }

    function changeImage(imageUrl) {
        const mainImage = document.getElementById('zoom-image');
        mainImage.src = imageUrl;
    }


    function addToCart(productId) {
        const color = document.getElementById("color") ? document.getElementById("color").value : null;
        const size = document.getElementById("size") ? document.getElementById("size").value : null;
        const cartMessage = document.getElementById("cart-message");

        fetch("{% url 'add_to_cart' %}", {
            method: "POST",
            headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: new URLSearchParams({
                "product_id": productId,
                "color": color,
                "size": size,
                "quantity": 1
            })
        })
            .then(response => response.json())
            .then(data => {
                cartMessage.style.display = "block";
                if (data.success) {
                    cartMessage.style.backgroundColor = "#d4edda"; // Green background for success
                    cartMessage.style.color = "#155724"; // Dark green text
                    cartMessage.innerText = data.message || "Item added to cart!";
                } else {
                    cartMessage.style.backgroundColor = "#f8d7da"; // Red background for error
                    cartMessage.style.color = "#721c24"; // Dark red text
                    cartMessage.innerText = data.error || "Error adding item to cart.";
                }
            })
            .catch(error => {
                cartMessage.style.display = "block";
                cartMessage.style.backgroundColor = "#f8d7da"; // Red background for error
                cartMessage.style.color = "#721c24"; // Dark red text
                cartMessage.innerText = "Error adding item to cart.";
                console.error("Error:", error);
            });
    }




    function showPopup(message) {
        const popup = document.getElementById("popup");
        popup.style.display = "flex";
        document.getElementById("text").innerText = message;

        setTimeout(() => {
            popup.style.display = "none";
        }, 3000);
    }


    window.onload = function () {
        updateSizes();
    };
</script>
{% endblock %}

{% endblock %}